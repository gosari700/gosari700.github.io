<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="turbolinks-cache-control" content="no-cache" />
  <title>Mobile Galaga</title>
  <link rel="stylesheet" href="style.css?v=3.1" />
</head>
<body>  <!-- ë“œë¡­ë‹¤ìš´ ë²„íŠ¼ (START ë²„íŠ¼ ì™¼ìª½) -->
  <div id="sentenceDropdown">
    <button id="dropdownBtn">&#9662;</button>
    <div id="sentenceList" class="sentence-list">
      <!-- ì—¬ê¸°ì— ë¬¸ì¥ ëª©ë¡ì´ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
    </div>
  </div>
  
  <!-- ìƒë‹¨ ì»¨íŠ¸ë¡¤ (ì¤‘ì•™ ê³ ì •) -->
  <div id="topControls">
    <button id="startBtn" class="start-btn">START</button>
    <button id="pauseBtn" class="pause-btn">PAUSE</button>
    <button id="stopBtn" class="stop-btn">STOP</button>
  </div>
  <!-- ë³¼ë¥¨ë²„íŠ¼: ì˜¤ë¥¸ìª½ ìƒë‹¨ì— ë³„ë„ ìœ„ì¹˜ -->
  <button id="volumeBtn" class="volume-btn">ğŸ”Š</button>  <!-- ë¬¸ì¥ ì´ë¯¸ì§€/ë™ì˜ìƒ í‘œì‹œë¥¼ ìœ„í•œ ì»¨í…Œì´ë„ˆ -->
  <div id="sentenceImageContainer" class="no-border-at-all" style="position:fixed !important; border:0 none transparent !important; box-shadow:none !important; outline:0 none transparent !important; background-color:transparent !important; top:48px !important;">
    <img id="sentenceImage" class="no-border-at-all" src="" alt="Sentence Image" style="border:0 none transparent !important; outline:0 none transparent !important; border-radius:0 !important; box-shadow:none !important; background-color:transparent !important; padding:0; margin:0;" />
    <!-- ë™ì˜ìƒ ìš”ì†ŒëŠ” ìë°”ìŠ¤í¬ë¦½íŠ¸ì—ì„œ í•„ìš”í•  ë•Œ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
  </div>

  <!-- ê²Œì„ ìº”ë²„ìŠ¤ -->
  <canvas id="gameCanvas"></canvas>

  <!-- í•˜ë‹¨ ì´ë¯¸ì§€/ë™ì˜ìƒ í‘œì‹œë¥¼ ìœ„í•œ ì»¨í…Œì´ë„ˆ -->
  <div id="bottomImageContainer" class="no-border-at-all" style="border:0 none transparent !important; box-shadow:none !important; outline:0 none transparent !important; background-color:transparent !important;">
    <img id="bottomImage" class="no-border-at-all" src="" alt="Bottom Image" style="border:0 none transparent !important; outline:0 none transparent !important; border-radius:0 !important; box-shadow:none !important; background-color:transparent !important; padding:0; margin:0;" />
    <!-- ë™ì˜ìƒ ìš”ì†ŒëŠ” ìë°”ìŠ¤í¬ë¦½íŠ¸ì—ì„œ í•„ìš”í•  ë•Œ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
  </div>

  <!-- ê¹€ íš¨ê³¼ë¥¼ ìœ„í•œ ìˆ¨ê²¨ì§„ ë¹„ë””ì˜¤ ìš”ì†Œ -->  <video id="coffeeSteamVideo" src="images/coffee6.webm" autoplay loop muted playsinline style="display: none;"></video>
  <script src="bottomImage.js?v=4.5"></script>
  <script src="script.js?v=2.6"></script>
  <script src="dropdown.js?v=1.1"></script>
  <script src="sentenceImage.js?v=1.2"></script>
  <script>
    // ë™ì˜ìƒ í”Œë ˆì´ì–´ ì»¨íŠ¸ë¡¤ í–¥ìƒì„ ìœ„í•œ ì¶”ê°€ ìŠ¤í¬ë¦½íŠ¸
    document.addEventListener('DOMContentLoaded', function() {
      // ëª¨ë°”ì¼ í„°ì¹˜ ì´ë²¤íŠ¸ ìµœì í™”
      function setupVideoControls() {
        // ë¹„ë””ì˜¤ ìš”ì†Œ ì°¾ê¸° ë˜ëŠ” ë‚˜ì¤‘ì— ìƒì„±ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ê¸°
        const checkForVideo = setInterval(() => {
          // ìƒë‹¨ê³¼ í•˜ë‹¨ ëª¨ë‘ í™•ì¸
          const video = document.getElementById('sentenceVideo') || document.getElementById('bottomVideo');
          if (video) {
            clearInterval(checkForVideo);
            console.log('ë¹„ë””ì˜¤ ìš”ì†Œ ë°œê²¬ - ì´ë²¤íŠ¸ ì²˜ë¦¬ ìµœì í™”:', video.id);
            
            // í´ë¦­/í„°ì¹˜ í•¸ë“¤ëŸ¬ ì •ì˜
            const handleVideoInteraction = function(event) {
              // ëª¨ë“  ì´ë²¤íŠ¸ ì „íŒŒ ì¤‘ì§€ ë° ê¸°ë³¸ ë™ì‘ ë°©ì§€
              event.stopPropagation();
              event.preventDefault();
              event.stopImmediatePropagation();
              
              console.log('ë¹„ë””ì˜¤ ì¸í„°ë™ì…˜ ê°ì§€ - ìœ í˜•:', event.type, 'ìš”ì†Œ:', event.target.id);
              
              // íŠ¹ì • ì»¨íŠ¸ë¡¤ ìš”ì†Œ í´ë¦­ ì—¬ë¶€ í™•ì¸ 
              const isControlElement = event.target.closest && 
                (event.target.closest('*[id*="controls"]') || 
                 event.target.closest('*[class*="controls"]') ||
                 event.target.closest('button'));
                
              // ì»¨íŠ¸ë¡¤ ìš”ì†Œë¥¼ í´ë¦­í•œ ê²½ìš° ê¸°ë³¸ ë™ì‘ í—ˆìš©
              if (isControlElement) {
                console.log('ì»¨íŠ¸ë¡¤ ìš”ì†Œ ê°ì§€ - ì›ë˜ ê¸°ëŠ¥ ìœ ì§€');
                return true; // ê¸°ë³¸ ë™ì‘ í—ˆìš©
              }
              
              try {
                // ë¹„ë””ì˜¤ ì˜ì—­ ìì²´ë¥¼ í´ë¦­í•œ ê²½ìš°ì—ë§Œ ì¬ìƒ/ì¼ì‹œì •ì§€ í† ê¸€
                if (video.paused) {
                  // ì—¬ëŸ¬ ë°©ì‹ìœ¼ë¡œ ì¬ìƒ ì‹œë„
                  video.play().catch(error => {
                    console.log('ê¸€ë¡œë²Œ í•¸ë“¤ëŸ¬ ì¬ìƒ ì—ëŸ¬:', error);
                    
                    // ì¬ì‹œë„ - ì•½ê°„ ì§€ì—° í›„
                    setTimeout(() => {
                      video.muted = true; // ìŒì†Œê±° í›„ ì‹œë„
                      video.play().then(() => {
                        video.muted = false; // ì„±ê³µí•˜ë©´ ìŒì†Œê±° í•´ì œ
                      }).catch(e => console.log('ì¬ì‹œë„ ì‹¤íŒ¨:', e));
                    }, 100);
                  });
                } else {
                  video.pause();
                }
              } catch (e) {
                console.log('ë¹„ë””ì˜¤ ì œì–´ ì˜¤ë¥˜:', e);
              }
              
              // ì¼ì‹œì ìœ¼ë¡œ ì´ë²¤íŠ¸ ì²˜ë¦¬ ë¹„í™œì„±í™”í•˜ì—¬ ì¤‘ë³µ í´ë¦­ ë°©ì§€
              video.removeEventListener('click', handleVideoInteraction);
              video.removeEventListener('touchstart', handleVideoInteraction);
              
              setTimeout(() => {
                video.addEventListener('click', handleVideoInteraction, {passive: false, capture: true});
                video.addEventListener('touchstart', handleVideoInteraction, {passive: false, capture: true});
              }, 300);
              
              return false;
            };
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ - ìº¡ì²˜ë§ ë‹¨ê³„ ë° ìˆ˜ë™ ì´ë²¤íŠ¸ ì²˜ë¦¬
            video.addEventListener('click', handleVideoInteraction, {passive: false, capture: true});
            video.addEventListener('touchstart', handleVideoInteraction, {passive: false, capture: true});
            
            // ë¹„ë””ì˜¤ ì»¨íŠ¸ë¡¤ëŸ¬ ì˜ì—­(í•˜ë‹¨ ë°”)ì˜ í´ë¦­/í„°ì¹˜ ì´ë²¤íŠ¸ëŠ” ì›ë˜ ê¸°ëŠ¥ ìœ ì§€
            video.addEventListener('touchstart', function(e) {
              const touch = e.touches[0];
              const videoRect = video.getBoundingClientRect();
              const controlsHeight = videoRect.height * 0.25; // í•˜ë‹¨ 25%ë¥¼ ì»¨íŠ¸ë¡¤ ì˜ì—­ìœ¼ë¡œ ê°„ì£¼
              
              // í„°ì¹˜ ìœ„ì¹˜ê°€ ë¹„ë””ì˜¤ í•˜ë‹¨ ì˜ì—­ì´ë©´ ì»¨íŠ¸ë¡¤ëŸ¬ ì˜ì—­ìœ¼ë¡œ ê°„ì£¼
              if (touch.clientY > (videoRect.bottom - controlsHeight)) {
                console.log('ì»¨íŠ¸ë¡¤ëŸ¬ ì˜ì—­ í„°ì¹˜ ê°ì§€ - ê¸°ë³¸ ê¸°ëŠ¥ í—ˆìš©');
                // ê¸°ë³¸ ì»¨íŠ¸ë¡¤ëŸ¬ ë™ì‘ í—ˆìš©í•˜ê¸° ìœ„í•´ ì´ë²¤íŠ¸ ì „íŒŒ í™•ì‹¤íˆ
                e.stopImmediatePropagation(); // ë‹¤ë¥¸ ë¦¬ìŠ¤ë„ˆ ì‹¤í–‰ ë°©ì§€
                return true; // ê¸°ë³¸ ë™ì‘ í—ˆìš©
              }
            }, {passive: false, capture: true});
            
            // í”Œë ˆì´ ìƒíƒœ ë³€ê²½ ê°ì§€
            video.addEventListener('play', function() {
              console.log('ê¸€ë¡œë²Œ í•¸ë“¤ëŸ¬: ë¹„ë””ì˜¤ ì¬ìƒ ì‹œì‘');
            });
            
            video.addEventListener('pause', function() {
              console.log('ê¸€ë¡œë²Œ í•¸ë“¤ëŸ¬: ë¹„ë””ì˜¤ ì¼ì‹œì •ì§€');
            });
          }
        }, 500);
      }
      
      // í˜ì´ì§€ ë¡œë“œ ì‹œ ë° DOM ë³€ê²½ ê°ì§€í•˜ì—¬ ë¹„ë””ì˜¤ ì œì–´ ì„¤ì •
      setupVideoControls();
      
      // Mutation Observerë¡œ DOM ë³€ê²½ ê°ì§€ (ë¹„ë””ì˜¤ ìš”ì†Œê°€ ë™ì ìœ¼ë¡œ ì¶”ê°€ë  ë•Œ)
      const observer = new MutationObserver(function(mutations) {
        for (const mutation of mutations) {
          if (mutation.addedNodes.length) {
            setupVideoControls();
            break;
          }
        }
      });
      
      // body ì „ì²´ ê´€ì°°
      observer.observe(document.body, { childList: true, subtree: true });
    });

    let isDropdownMp3Playing = false;
    let dropdownMp3Audio = null;
    let dropdownMp3Index = 0;
    let dropdownSentenceIndex = Number(localStorage.getItem('dropdownSentenceIndex')) || 0;
    let gameSentenceIndex = Number(localStorage.getItem('gameSentenceIndex')) || 0;

    function stopDropdownMp3Playback() {
      isDropdownMp3Playing = false;
      if (dropdownMp3Audio) {
        dropdownMp3Audio.pause();
        dropdownMp3Audio = null;
      }
    }

    function playAllSentenceMp3sFromStart(startIndex = null) {
      stopDropdownMp3Playback();
      isDropdownMp3Playing = true;
      if (typeof startIndex === 'number' && startIndex >= 0 && startIndex < 96) {
        dropdownMp3Index = startIndex;
      }
      function playNext() {
        if (!isDropdownMp3Playing) {
          // ë°°ê²½ìƒ‰ ëª¨ë‘ ì œê±°
          const items = document.querySelectorAll('.sentence-item');
          items.forEach(item => item.classList.remove('dropdown-reading-bg'));
          stopDropdownMp3Playback();
          return;
        }
        if (dropdownMp3Index >= 96) {
          dropdownMp3Index = 0; // 1ë²ˆ(0ë²ˆ ì¸ë±ìŠ¤)ë¶€í„° ë‹¤ì‹œ ë°˜ë³µ
        }
        // ëª¨ë“  ë¬¸ì¥ì—ì„œ íŒŒë€ ë°” ì œê±°
        const allItems = document.querySelectorAll('.sentence-item');
        allItems.forEach(item => item.classList.remove('dropdown-reading-bg'));
        // í˜„ì¬ ì½ëŠ” ë¬¸ì¥ì—ë§Œ íŒŒë€ ë°” ì¶”ê°€
        const curItem = document.querySelector(`.sentence-item[data-index='${String(dropdownMp3Index)}']`);
        if (curItem) {
          curItem.classList.add('dropdown-reading-bg');
          console.log('ë°°ê²½ ì¶”ê°€:', dropdownMp3Index);
        }
        const audioFilePath = `sounds/96_audio/${dropdownMp3Index + 1}.mp3`;
        dropdownMp3Audio = new Audio(audioFilePath);
        dropdownMp3Audio.volume = 0.8;
        dropdownMp3Audio.onended = () => {
          dropdownSentenceIndex = dropdownMp3Index;
          localStorage.setItem('dropdownSentenceIndex', dropdownSentenceIndex.toString());
          dropdownMp3Index++;
          playNext();
        };
        dropdownMp3Audio.onerror = () => {
          dropdownSentenceIndex = dropdownMp3Index;
          localStorage.setItem('dropdownSentenceIndex', dropdownSentenceIndex.toString());
          dropdownMp3Index++;
          playNext();
        };
        dropdownMp3Audio.play();
      }
      playNext();
    }

    // script.jsì—ì„œ ì •ì˜ëœ initializeSentenceDropdown í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
    // ì—¬ê¸°ì„œëŠ” í•¨ìˆ˜ ì •ì˜ë¥¼ ì œê±°í•˜ê³  ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ í›„ ìë™ìœ¼ë¡œ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.

    document.getElementById('startBtn').onclick = function() {
      // ë“œë¡­ë‹¤ìš´ì´ ì—´ë ¤ìˆì„ ë•ŒëŠ” START ë²„íŠ¼ ê¸°ëŠ¥ ë¹„í™œì„±í™”
      const sentenceList = document.getElementById('sentenceList');
      if (sentenceList && sentenceList.style.display === 'block') {
        console.log("ë“œë¡­ë‹¤ìš´ ì—´ë¦° ìƒíƒœì—ì„œ START ë²„íŠ¼ í´ë¦­ - ë¬´ì‹œ");
        return false;
      }
      
      if (!isGameRunning && !isGamePaused) {
        startGame();
      }
      // else: ì•„ë¬´ ë™ì‘ ì—†ìŒ
    };
    
    // sentenceItem ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ëŠ” script.jsì—ì„œ ì´ë¯¸ ì •ì˜ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ì œê±°
    // ì´ ì½”ë“œëŠ” ë¬¸ë§¥ì´ ì—†ì–´ ì œëŒ€ë¡œ ì‘ë™í•˜ì§€ ì•ŠìŒ

    // í­ë°œ ì‹œ
    function onExplosion() {
      // ...
      gameSentenceIndex = í˜„ì¬_í­ë°œ_ë¬¸ì¥_ì¸ë±ìŠ¤;
      localStorage.setItem('gameSentenceIndex', gameSentenceIndex.toString());
    }

    // ì´ ë¶€ë¶„ script.jsì—ì„œ ì²˜ë¦¬í•˜ë¯€ë¡œ ì‚­ì œ
    // sentenceNumber, sentenceText í´ë¦­ ì´ë²¤íŠ¸ëŠ” script.jsì˜ populateSentenceList í•¨ìˆ˜ì— ì •ì˜ë¨
    
    // populateSentenceListì—ì„œ ê° sentence-itemì— data-index ë¶€ì—¬
    sentenceItem.className = 'sentence-item';
    sentenceItem.setAttribute('data-index', index);

    document.getElementById('pauseBtn').onclick = function() {
      // ë“œë¡­ë‹¤ìš´ì´ ì—´ë ¤ìˆì„ ë•ŒëŠ” PAUSE/RESUME ë²„íŠ¼ ê¸°ëŠ¥ ë¹„í™œì„±í™”
      const sentenceList = document.getElementById('sentenceList');
      if (sentenceList && sentenceList.style.display === 'block') {
        console.log("ë“œë¡­ë‹¤ìš´ ì—´ë¦° ìƒíƒœì—ì„œ PAUSE/RESUME ë²„íŠ¼ í´ë¦­ - ë¬´ì‹œ");
        return false;
      }
      
      if (!window.isGamePaused) {
        // PAUSE ë²„íŠ¼ í´ë¦­: PAUSE -> RESUME ìƒíƒœë¡œ ë³€ê²½ (ê²Œì„ ì¼ì‹œì •ì§€)
        togglePause();
        this.textContent = 'RESUME';
        window.isGamePaused = true;
        
        // ê²Œì„ì´ ì¼ì‹œì •ì§€ë¨ -> í•˜ë‹¨ ë¯¸ë””ì–´ëŠ” ì•„ë˜ì—ì„œ ì˜¬ë¼ì˜¤ê²Œ í•¨
        if (typeof onGamePaused === 'function') {
          onGamePaused();
        }
      } else {
        // RESUME ë²„íŠ¼ í´ë¦­: RESUME -> PAUSE ìƒíƒœë¡œ ë³€ê²½ (ê²Œì„ ì¬ê°œ)
        togglePause();
        this.textContent = 'PAUSE';
        window.isGamePaused = false;
        
        // ê²Œì„ì´ ì¬ê°œë¨ -> í•˜ë‹¨ ë¯¸ë””ì–´ëŠ” ì•„ë˜ì—ì„œ ì˜¬ë¼ì˜¤ê²Œ í•¨
        if (typeof onGameResumed === 'function') {
          onGameResumed();
        }
      }
    };

    function pauseBottomMedia() {
      // ë™ì˜ìƒ
      const bottomVideo = document.getElementById('bottomVideo');
      if (bottomVideo && !bottomVideo.paused) bottomVideo.pause();
      // ì˜¤ë””ì˜¤ë„ ìˆë‹¤ë©´
      const bottomAudio = document.getElementById('bottomAudio');
      if (bottomAudio && !bottomAudio.paused) bottomAudio.pause();
    }

    function resumeBottomMedia() {
      const bottomVideo = document.getElementById('bottomVideo');
      if (bottomVideo && bottomVideo.paused) bottomVideo.play();
      // í•„ìš”ì‹œ ì˜¤ë””ì˜¤ë„ ì¶”ê°€
      // const bottomAudio = document.getElementById('bottomAudio');
      // if (bottomAudio && bottomAudio.paused) bottomAudio.play();
    }
  </script>
</body>
</html>